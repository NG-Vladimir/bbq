<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–ú–∏–Ω–∏ BBQ/–ì—Ä–∏–ª—å | Telegram MiniApp</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

<div class="container">

  <div class="tabs" id="tabs">
    <button class="tab-btn active" data-cat="BBQ">BBQ</button>
    <button class="tab-btn" data-cat="–ì–†–ò–õ–¨">–ì—Ä–∏–ª—å</button>
    <button class="tab-btn" data-cat="–°–û–£–°–´">–°–æ—É—Å—ã</button>
  </div>

  <h2 class="app-title" id="cat-title">–ú–µ–Ω—é BBQ</h2>

  <div id="products-section">
    <div class="products-list" id="products-list"></div>
    <button id="show-all-btn" class="show-all-btn">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë –º–µ–Ω—é</button>
  </div>

  <button class="cart-btn" id="cart-btn" disabled>
    –ö–æ—Ä–∑–∏–Ω–∞ <span class="cart-count" id="cart-count">(0)</span>
  </button>

  <div id="cart-modal" class="cart-modal">
    <div class="cart-content">
      <h3>–ö–æ—Ä–∑–∏–Ω–∞</h3>
      <div id="cart-items"></div>
      <div class="cart-total-row">
        <span>–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞:</span>
        <span id="cart-total-sum">0 —Ä—É–±</span>
      </div>
      <button class="confirm-btn" id="confirm-btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
      <button class="close-cart-btn" id="close-cart-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <div id="thanks-modal" class="cart-modal">
    <div class="cart-content">
      <h3>–°–ø–∞—Å–∏–±–æ!</h3>
      <p>–í–∞—à –∑–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω üëå</p>
      <button class="close-cart-btn" onclick="window.Telegram.WebApp.close()">–ó–∞–∫—Ä—ã—Ç—å MiniApp</button>
    </div>
  </div>

</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();

// ===============================
// –î–ê–ù–ù–´–ï –ú–ï–ù–Æ
// ===============================
const MENU = [
  { category: 'BBQ', items: [
    { name: '–ì–æ–≤—è–¥–∏–Ω–∞ (—Ä–≤–∞–Ω–æ–µ –º—è—Å–æ)', price: 8.5, unit: '100–≥' },
    { name: '–ì–æ–≤—è–∂–∏–π —è–∑—ã–∫', price: 9.5, unit: '100–≥' },
    { name: '–ë—É–∂–µ–Ω–∏–Ω–∞ (—à–µ—è)', price: 7.5, unit: '100–≥' },
    { name: '–°–≤–∏–Ω–∏–Ω–∞ (—Ä–≤–∞–Ω–æ–µ –º—è—Å–æ)', price: 6.5, unit: '100–≥' },
    { name: '–†—ë–±—Ä—ã—à–∫–∏ (—Ç–æ–ª—Å—Ç—ã–µ)', price: 8, unit: '100–≥' },
    { name: '–†—ë–±—Ä—ã—à–∫–∏ (–º—è—Å–Ω—ã–µ)', price: 5, unit: '100–≥' },
    { name: '–†—É–ª—å–∫–∞ (—Å–≤–∏–Ω–∏–Ω–∞)', price: 5, unit: '100–≥' },
    { name: '–ö—É—Ä–∏–Ω–æ–µ (–º—è—Å–æ)', price: 5.5, unit: '100–≥' },
    { name: '–ò–Ω–¥–µ–π–∫–∞ (–±–µ–¥—Ä–æ)', price: 7, unit: '100–≥' },
    { name: '–ò–Ω–¥–µ–π–∫–∞ (–≥–æ–ª–µ–Ω—å)', price: 6, unit: '100–≥' },
    { name: '–ú—è—Å–æ –∏–Ω–¥–µ–π–∫–∏', price: 9, unit: '100–≥' },
    { name: '–£—Ç–∫–∞ —Å –∑–∞–ø–µ—á. —è–±–ª.', price: 7, unit: '100–≥' },
  ] },
  { category: '–ì–†–ò–õ–¨', items: [
    { name: '–ê–≤—Ç–æ—Ä—Å–∫–∏–π —à–∞—à–ª—ã–∫ (—à–µ—è)', price: 7, unit: '100–≥' },
    { name: '–†—ë–±—Ä—ã—à–∫–∏ (—Å–≤–∏–Ω—ã–µ)', price: 7, unit: '100–≥' },
    { name: '–ö—É—Ä–∏–Ω—ã–µ (—á—É–ø–∞-—á—É–ø—Å—ã) –≤ —Ñ. —Å–æ—É—Å–µ', price: 6, unit: '100–≥' },
    { name: '–ö—É—Ä–∏–Ω—ã–µ –∫—Ä—ã–ª—ã—à–∫–∏', price: 6, unit: '100–≥' },
    { name: '–ö—É—Ä–∏–Ω—ã–µ —Å–µ—Ä–¥–µ—á–∫–∏', price: 6, unit: '100–≥' },
    { name: '–î–æ–º–∞—à–Ω–∏–µ –∫–æ–ª–±–∞—Å–∫–∏', price: 7, unit: '100–≥' },
  ] },
  { category: '–°–û–£–°–´', items: [
    { name: '–ë–∞—Ä–±–µ–∫—é', price: 4, unit: '50–≥' },
    { name: '–§–∏—Ä–º–µ–Ω–Ω—ã–π —Å—ã—Ä–Ω—ã–π', price: 4, unit: '50–≥' },
    { name: '–ß–∏–ª–∏ —Å–ª–∞–¥–∫–∏–π', price: 4, unit: '50–≥' },
  ] }
];

const SHORT_LIMIT = 3;
let cart = {};
let currentCat = 'BBQ';
let allMenuShown = false;

function itemKey(item){ return `${item.name}|${item.price}|${item.unit}`; }
function findItemByKey(key){ for(const cat of MENU) for(const it of cat.items) if(itemKey(it)===key) return it; }

function renderTabs(){
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.cat === currentCat));
}

function renderProducts(){
  const sectionTitle = document.getElementById('cat-title');
  sectionTitle.textContent = `–ú–µ–Ω—é ${currentCat}`;
  const list = document.getElementById('products-list');
  list.innerHTML = '';
  const cat = MENU.find(c=>c.category===currentCat);
  const items = allMenuShown?cat.items:cat.items.slice(0,SHORT_LIMIT);
  items.forEach(item=>{
    const card=document.createElement('div'); card.className='product-card';
    card.innerHTML=`
      <div class="product-info">
        <div class="product-name">${item.name}</div>
        <div class="product-meta">${item.price} —Ä—É–±/${item.unit}</div>
      </div>
      <div class="product-amount">
        <button class="btn minus" ${!cart[itemKey(item)]?'disabled':''}>-</button>
        <span class="amount">${cart[itemKey(item)]||0}</span>
        <button class="btn plus">+</button>
      </div>
    `;
    const minus=card.querySelector('.minus');
    const plus=card.querySelector('.plus');
    plus.onclick=()=>{ cart[itemKey(item)]=(cart[itemKey(item)]||0)+1; renderProducts(); renderCartItems(); updateCartBtn(); };
    minus.onclick=()=>{ if(cart[itemKey(item)]){ cart[itemKey(item)]--; if(cart[itemKey(item)]<=0) delete cart[itemKey(item)]; renderProducts(); renderCartItems(); updateCartBtn(); } };
    list.appendChild(card);
  });
  document.getElementById('show-all-btn').style.display=(!allMenuShown && cat.items.length>SHORT_LIMIT)?'block':'none';
}

// ==========================
// –†–µ–Ω–¥–µ—Ä –∫–æ—Ä–∑–∏–Ω—ã
// ==========================
function renderCartItems(){
  const cartContainer = document.getElementById('cart-items');
  cartContainer.innerHTML = '';
  let total = 0;
  Object.entries(cart).forEach(([key, amount])=>{
    const item = findItemByKey(key);
    if(!item) return;
    const sum = item.price * amount;
    total += sum;
    const row = document.createElement('div'); row.className='cart-row';
    row.innerHTML=`
      <div class="cart-item-title">${item.name}</div>
      <div class="cart-item-meta">${item.price} —Ä—É–±/${item.unit}</div>
      <div class="cart-edit">
        <button class="btn minus">-</button>
        <span class="amount">${amount}</span>
        <button class="btn plus">+</button>
        <button class="btn remove">x</button>
      </div>
      <div class="cart-item-sum">${sum.toFixed(2)} —Ä—É–±</div>
    `;
    row.querySelector('.plus').onclick = ()=>{ cart[key]++; renderCartItems(); renderProducts(); updateCartBtn(); };
    row.querySelector('.minus').onclick = ()=>{ if(cart[key]>0){ cart[key]--; if(cart[key]<=0) delete cart[key]; renderCartItems(); renderProducts(); updateCartBtn(); } };
    row.querySelector('.remove').onclick = ()=>{ delete cart[key]; renderCartItems(); renderProducts(); updateCartBtn(); };
    cartContainer.appendChild(row);
  });
  document.getElementById('cart-total-sum').textContent = `${total.toFixed(2)} —Ä—É–±`;
}

function updateCartBtn(){
  let totalAmount = Object.values(cart).reduce((a,b)=>a+b,0);
  document.getElementById('cart-count').textContent=`(${totalAmount})`;
  document.getElementById('cart-btn').disabled = totalAmount===0;
}

// ==========================
// –°–æ–±—ã—Ç–∏—è
// ==========================
document.getElementById('show-all-btn').onclick=()=>{ allMenuShown=true; renderProducts(); renderTabs(); };
document.querySelectorAll('.tab-btn').forEach(btn=>{ btn.onclick=()=>{ currentCat=btn.dataset.cat; allMenuShown=false; renderTabs(); renderProducts(); }; });
document.getElementById('cart-btn').onclick=()=>{ renderCartItems(); document.getElementById('cart-modal').style.display='flex'; };
document.querySelectorAll('.close-cart-btn').forEach(btn=>{ btn.onclick=()=>{ document.getElementById('cart-modal').style.display='none'; document.getElementById('thanks-modal').style.display='none'; }; });

// ==========================
// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≤ Telegram
// ==========================
document.getElementById('confirm-btn').onclick=()=>{
  const items = [];
  Object.entries(cart).forEach(([key, amount])=>{
    const item = findItemByKey(key);
    if(item && amount>0) items.push({name:item.name, price:item.price, unit:item.unit, count:amount});
  });
  const total = items.reduce((s,it)=>s+it.price*it.count,0);
  const order = {items, total};
  
  tg.sendData(JSON.stringify(order));

  cart = {};
  renderProducts();
  updateCartBtn();
  document.getElementById('cart-modal').style.display='none';
  document.getElementById('thanks-modal').style.display='flex';
};

// ==========================
// –ó–∞–ø—É—Å–∫
// ==========================
window.onload = ()=>{ renderTabs(); renderProducts(); updateCartBtn(); };
</script>

</body>
</html>